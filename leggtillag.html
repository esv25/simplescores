<!DOCTYPE html>
<html>
<head>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta charset="utf8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Legg til lag</title>
  <meta property="og:title" content="Legg til lag">
  <meta property="og:description" content="Registrer et nytt lag.">
  <meta property="og:image" content="logo.png">
  <meta property="og:url" content="https://ditt-domene.no/leggtillag.html">
  <link rel="stylesheet" type="text/css" href="./admin.css">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <style>
    /* Sørg for at header og nav alltid ligger over innhold */
    header, nav {
      position: relative;
      z-index: 2000;
    }

    /* Hindrer at siden kan skrolle horisontalt */
    html, body {
      overflow-x: hidden;
    }

    /* Wrapper rundt sidebar og hovedinnhold */
    .content-wrapper {
      position: relative;
      display: flex;
      align-items: flex-start;
      gap: 20px;
    }


    /* Sideheading */
    .page-header {
      text-align: center;
      margin: 20px 0;
    }
    .page-header h1 {
      font-size: 2rem;
      margin-bottom: 0.25rem;
    }
    .page-header p {
      color: #555;
    }
/* Overlay */
.modal {
  display: none;
  position: fixed;
  z-index: 3000;
  inset: 0; /* top:0; right:0; bottom:0; left:0; */
  background-color: rgba(0, 0, 0, 0.5);
}

/* Selve boksen */
.modal-content {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 400px;
  max-width: 90%;
  background-color: #fff;
  padding: 24px;
  border-radius: 8px;
  box-shadow: 0 5px 15px rgba(0,0,0,0.3);
  font-family: "Roboto", sans-serif;
}

.modal.desktop {
  background-color: transparent;
  pointer-events: none;
  top: var(--offset-top, 0);
  height: calc(100% - var(--offset-top, 0));
}

  .modal.desktop .modal-content {
    pointer-events: auto;
  }

  /* Sidebar form styling */
  .team-form-sidebar,
  .ref-form-sidebar {
    display: none;
    position: fixed;
    top: var(--offset-top, 0);
    right: 0;
    width: 300px;
    max-width: 90%;
    height: calc(100% - var(--offset-top, 0));
    background: #fff;
    border-radius: 8px;
    padding: 20px;
    box-shadow: -2px 0 5px rgba(0,0,0,0.1);
    overflow-y: auto;
    z-index: 2600;
  }
  .team-form-sidebar .close-sidebar,
  .ref-form-sidebar .close-sidebar {
    position: absolute;
    top: 8px;
    right: 12px;
    font-size: 22px;
    cursor: pointer;
  }

/* Close-knapp */
.modal-content .close {
  position: absolute;
  right: 16px;
  top: 12px;
  font-size: 22px;
  cursor: pointer;
}

/* Form‑elementer */
.modal-content form {
  display: flex;
  flex-direction: column;
  gap: 12px;
}
.modal-content label {
  font-weight: 700;
}
.modal-content input[type="text"],
.modal-content textarea {
  width: 100%;
  padding: 8px;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: 0.95rem;
}

/* Knapp i form */
.modal-content button {
  align-self: center;
  padding: 10px 20px;
  background-color: #596bff;
  color: #fff;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 1rem;
}
.modal-content button:hover {
  background-color: #4a5ddd;
}
    /* Tabs and cards */
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      justify-content: center;
    }
    .tab-btn {
      padding: 8px 16px;
      background-color: #eee;
      border: 1px solid #ddd;
      cursor: pointer;
      border-radius: 4px;
      font-weight: 600;
      transition: background-color 0.2s;
    }
    .tab-btn.active {
      background-color: #596bff;
      color: #fff;
    }
    .tab-section { display: none; }
    .tab-section.active { display: block; }
    .actions { margin-bottom: 10px; display: flex; gap: 10px; align-items: center; }

    .card-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }
    .team-card, .ref-card {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 1rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      cursor: pointer;
      position: relative;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .team-card:hover, .ref-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    .team-card .actions, .ref-card .actions {
      margin-top: auto;
      display: flex;
      gap: 5px;
      align-self: flex-end;
    }
    .team-card button, .ref-card button {
      background-color: #596bff;
      color: #fff;
      border: none;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8rem;
    }
    .team-card button:hover, .ref-card button:hover { background-color: #4a5ddd; }

      .checkbox-group label { display: block; margin-bottom: 4px; }
      .checkbox-group input { margin-right: 6px; }
    .team-card ul { list-style: disc; padding-left: 1.2rem; margin: 0; width: 100%; }

    @media (min-width: 768px) {
      .modal.desktop .modal-content {
        right: 0;
        left: auto;
        top: 0; /* Position directly below nav */
        transform: none;
        height: 100%;
        border-radius: 0;
      }
    }
  </style>
</head>
<body>

  <header>
    <div class="logo-title">
      <a href="nyTurnering.html"><img src="logo.png" alt="Simple Scores Logo" class="logo"></a>
    </div>
    <div class="nav2">
      <button id="user-button" onclick="toggleUserMenu()">User</button>
      <div id="user-menu" class="user-menu" style="display: none;">
        <p>Logget inn som <span id="mail"></span></p>
        <button id="loggut" onclick="loggut()">Sign out</button>
      </div>
      <button onclick="window.location.href='publikum.html'">Publikum</button>
    </div>
  </header>
  <nav>
    <button class="meny-ikon" id="meny-knapp" aria-label="Åpne meny" aria-expanded="false" aria-controls="meny"></button>
    <ul id="meny">
      <li><a href="slideshowEditor.html">Slideshow</a></li>
      <li><a href="instillinger.html">Instillinger</a></li>
      <li><a href="leggtillag.html">Legg til lag</a></li>
      <li><a href="format.html">Format</a></li>
      <li><a href="kampoppsett.html">Kampoppsett</a></li>
      <li><a href="kamper.html">Kamper</a></li>
    </ul>
  </nav>

  <div class="page-header">
    <h1>Administrer lag og dommere</h1>
    <p>Legg til eller rediger lag og dommere for turneringen.</p>
  </div>

  <div class="content-wrapper">

  <main>
<div id="teamSidebar" class="team-form-sidebar">
  <span class="close-sidebar" onclick="closeTeamForm()">&times;</span>
  <form id="addTeamForm" class="space-y-4">
    <label for="teamName">Team name:</label>
    <input type="text" id="teamName" name="teamName" placeholder="Skriv lagnavn" class="border rounded w-full p-2">
    <label for="spillerliste">Playerlist:</label>
    <textarea id="spillerliste" name="spillerliste" rows="5" placeholder="Type in playernames, one per line" class="border rounded w-full p-2"></textarea>
    <button id="saveTeamBtn" type="button" onclick="saveTeam()" class="btn w-full">Add team</button>
  </form>
</div>


<!-- Referee Form Sidebar -->
<div id="refSidebar" class="ref-form-sidebar">
  <span class="close-sidebar" onclick="closeRefForm()">&times;</span>
  <form id="addRefForm" class="space-y-4">
    <label for="refereeName">Name</label>
      <input type="text" id="refereeName" name="refereeName" placeholder="Referee Name" class="border rounded w-full p-2">

    <label for="refereeTeam">Team</label>
      <select id="refereeTeam" name="refereeTeam" class="border rounded w-full p-2">
      <option value="">—</option>
      <!-- Teams legges til dynamisk via JS -->
    </select>

    <label>Divisions</label>
    <div id="refereeDivisionsContainer" class="checkbox-group space-y-2">
      <!-- JS fyller ut én checkbox per divisjon -->
    </div>

      <button id="saveRefBtn" type="button" onclick="saveReferee()" class="btn w-full">Add Referee</button>
  </form>
</div>



    <!-- Innhold for lag og dommere -->
    <div class="tabs">
      <button class="tab-btn active" onclick="showTab('teams', this)">Teams</button>
      <button class="tab-btn" onclick="showTab('refs', this)">Referees</button>
    </div>
    <section id="teams" class="tab-section active">
      <div class="actions">
        <select id="divisionDropdown" onchange="hentOgVisLag()">
          <!-- Divisjoner vil bli populert her av JavaScript -->
        </select>
        <button id="addTeamBtn" onclick="openTeamForm()" class="btn">Add team</button>
      </div>
      <div id="lagContainer" class="card-list"></div>
    </section>

    <section id="refs" class="tab-section">
      <div class="actions">
        <button id="addref" onclick="openRefereeForm()" class="btn">Add referee</button>
      </div>
      <div id="dommerListe" class="card-list"></div>
    </section>

  </main>
  </div>
  <footer class="site-footer">
    <div class="footer-container">
      <p>Contact us: <a href="mailto:contact@example.com">contact@example.com</a></p>
      <p>Phone: +47 12345678</p>
    </div>
  </footer>
    
  <!-- Firebase og øvrig JavaScript -->
  <script src="https://www.gstatic.com/firebasejs/8.2.0/firebase-app.js"></script>
    <script src="firebaseConfig.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.2.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.2.0/firebase-auth.js"></script>
  
  <script>
    
    // Hent turnerings-ID fra querystring
    const turneringId = new URLSearchParams(window.location.search).get('id');
    console.log(turneringId);
    
    // Initialize Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    let editingTeamId = null;
    let editingRefereeId = null;
    
    auth.onAuthStateChanged((user) => {
      if (user) {
        const email = user.email;
        document.getElementById('mail').innerHTML = email;
      } else {
        window.location.href = 'login.html';
      }
    });
    
    function loggut() {
      auth.signOut().then(() => {
        window.location.href = 'login.html';
      }).catch((error) => {
        console.error("Feil ved utlogging:", error);
      });
    }
    async function populateTeamsDropdown() {
  const select = document.getElementById('refereeTeam');
  select.innerHTML = '<option value="">—</option>';
  const snapshot = await db
    .collection('turneringer')
    .doc(turneringId)
    .collection('lag')
    .get();
  snapshot.forEach(doc => {
    const { lagNavn } = doc.data();
    const opt = document.createElement('option');
    opt.value = doc.id;
    opt.textContent = lagNavn;
    select.appendChild(opt);
  });
}

    // Funksjoner for lag og dommere
    function applyModalOffset(modal){
      const header = document.querySelector('header');
      const nav = document.querySelector('nav');
      const offset = (header ? header.offsetHeight : 0) + (nav ? nav.offsetHeight : 0);
      modal.style.setProperty('--offset-top', offset + 'px');
    }

    function openTeamForm(id){
      editingTeamId = id || null;
      document.getElementById('saveTeamBtn').textContent = editingTeamId ? 'Save team' : 'Add team';
      document.getElementById('teamName').value = '';
      document.getElementById('spillerliste').value = '';
      if(id){
        db.collection('turneringer').doc(turneringId).collection('lag').doc(id).get().then(doc => {
          if(doc.exists){
            const data = doc.data();
            document.getElementById('teamName').value = data.lagNavn || '';
            document.getElementById('spillerliste').value = (data.spillere || []).join('\n');
          }
        });
      }
      const sidebar = document.getElementById('teamSidebar');
      if(window.innerWidth >= 768){
        applyModalOffset(sidebar);
      } else {
        sidebar.style.removeProperty('--offset-top');
      }
  sidebar.style.display = 'block';
}

function closeTeamForm(){
  const sidebar = document.getElementById('teamSidebar');
  if(sidebar) sidebar.style.display = 'none';
}

function closeRefForm(){
  const sidebar = document.getElementById('refSidebar');
  if(sidebar) sidebar.style.display = 'none';
}
    
    async function populateDivisionDropdown() {
      try {
        if (!turneringId) {
          console.error('Turnerings-ID mangler. Kan ikke hente divisjoner.');
          return;
        }
        const docRef = db.collection('turneringer').doc(turneringId);
        const doc = await docRef.get();
        if (!doc.exists) {
          console.error('Fant ikke turneringsdokumentet.');
          return;
        }
        const tournamentData = doc.data();
        const divisions = tournamentData.divisions || [];
        const divisionDropdown = document.getElementById('divisionDropdown');
        if (!divisionDropdown) {
          console.error('Dropdown med ID "divisionDropdown" ble ikke funnet.');
          return;
        }
        divisionDropdown.innerHTML = '';
        const defaultOption = document.createElement('option');
        defaultOption.textContent = 'Velg divisjon';
        defaultOption.value = '';
        divisionDropdown.appendChild(defaultOption);
        divisions.forEach(division => {
          const option = document.createElement('option');
          option.textContent = division.name;
          option.value = division.name;
          divisionDropdown.appendChild(option);
        });
        // Velg første divisjon automatisk dersom den finnes
        if (divisions.length > 0) {
          divisionDropdown.selectedIndex = 1; // hopp over "Velg divisjon"
          hentOgVisLag();
        }
      } catch (error) {
        console.error('Feil ved henting av divisjoner:', error);
      }
    }
    
    document.addEventListener('DOMContentLoaded', populateDivisionDropdown);
// 1) Fyll ut checkbox-lista ved oppstart
async function populateDivisionsCheckboxes() {
  const container = document.getElementById('refereeDivisionsContainer');
  container.innerHTML = '';  // tøm for sikkerhets skyld

  const tourSnap = await db
    .collection('turneringer')
    .doc(turneringId)
    .get();
  const divisions = tourSnap.data().divisions || [];

  divisions.forEach(div => {
    const label = document.createElement('label');
    label.style.display = 'block';  // én rad per checkbox

    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.name = 'refereeDivisions';
    cb.value = div.name;  // eller div.id hvis du heller vil

    label.appendChild(cb);
    label.appendChild(document.createTextNode(' ' + div.name));
    container.appendChild(label);
  });
}

// 2) Kjør ved DOMContentLoaded
document.addEventListener('DOMContentLoaded', () => {
  populateTeamsDropdown();           // eksisterende
  populateDivisionsCheckboxes();     // nye funksjonen
  openTeamForm();
});

    async function populateDivisionsDropdown() {
  const select = document.getElementById('refereeDivisions');
  select.innerHTML = '';  // tømmer evt. tidligere options

  const tourSnap = await db
    .collection('turneringer')
    .doc(turneringId)
    .get();

  const divisions = tourSnap.data().divisions || [];
  divisions.forEach(div => {
    const opt = document.createElement('option');
    opt.value = div.name;      // eller div.id hvis du har
    opt.textContent = div.name;
    select.appendChild(opt);
  });
}


    function openRefereeForm(id){
      editingRefereeId = id || null;
      document.getElementById('saveRefBtn').textContent = editingRefereeId ? 'Save' : 'Add Referee';
      document.getElementById('refereeName').value = '';
      document.getElementById('refereeTeam').value = '';
      populateDivisionsCheckboxes().then(() => {
        if(id){
          db.collection('turneringer').doc(turneringId).collection('dommere').doc(id).get().then(doc => {
            if(doc.exists){
              const data = doc.data();
              document.getElementById('refereeName').value = data.dommer || '';
              document.getElementById('refereeTeam').value = data.teamId || '';
              if(data.divisions){
                const checkboxes = document.querySelectorAll('#refereeDivisionsContainer input[name="refereeDivisions"]');
                checkboxes.forEach(cb => { cb.checked = data.divisions.includes(cb.value); });
              }
            }
          });
        }
      });
      const sidebar = document.getElementById('refSidebar');
      if(window.innerWidth >= 768){
        applyModalOffset(sidebar);
      } else {
        sidebar.style.removeProperty('--offset-top');
      }
      sidebar.style.display = 'block';
    }

    function saveReferee() {
      const name = document.getElementById('refereeName').value.trim();
      const teamId = document.getElementById('refereeTeam').value || null;
      const teamName = teamId ? document.querySelector(`#refereeTeam option[value="${teamId}"]`).textContent : '';
      const divisions = Array.from(document.querySelectorAll('#refereeDivisionsContainer input[name="refereeDivisions"]:checked')).map(cb => cb.value);

      const refData = { dommer: name, teamId, teamName, divisions };
      const refsRef = db.collection('turneringer').doc(turneringId).collection('dommere');

      const p = editingRefereeId ? refsRef.doc(editingRefereeId).set(refData) : refsRef.add(refData);
      p.then(() => {
          closeRefForm();
          editingRefereeId = null;
          hentDommere();
        })
        .catch(error => console.error('Feil ved lagring av dommer:', error));
    }

    function saveTeam() {
      const lagNavn = document.getElementById('teamName').value.trim();
      const spillerliste = document.getElementById('spillerliste')
        .value
        .split('\n')
        .map(s => s.trim())
        .filter(s => s);
      const div = document.getElementById('divisionDropdown').value;

      const lagData = { lagNavn: lagNavn, spillere: spillerliste, divisjon: div };
      const teamsRef = db.collection('turneringer').doc(turneringId).collection('lag');

      const p = editingTeamId
        ? teamsRef.doc(editingTeamId).set(lagData)
        : teamsRef.add(lagData);

      p.then(() => {
          closeTeamForm();
          editingTeamId = null;
          hentOgVisLag();
        })
        .catch(error => console.error('Feil ved lagring av lag:', error));
    }

    function slettLag(lagId){
      db.collection('turneringer').doc(turneringId).collection('lag').doc(lagId).delete()
        .then(() => {
          console.log('Lag slettet');
          hentOgVisLag();
        })
        .catch(error => {
          console.error('Feil ved sletting av lag:', error);
        });
    }

    function hentOgVisLag() {
      if (!turneringId) return;
      const selectedDivision = document.getElementById('divisionDropdown').value;
      if (!selectedDivision) return;

      db.collection('turneringer').doc(turneringId).collection('lag')
        .where('divisjon', '==', selectedDivision)
        .get()
        .then(snapshot => {
          const container = document.getElementById('lagContainer');
          container.innerHTML = '';
          snapshot.forEach(doc => {
            const lag = doc.data();
            const card = document.createElement('div');
            card.className = 'team-card';
            card.addEventListener('click', () => openTeamForm(doc.id));
            const header = document.createElement('h3');
            header.textContent = lag.lagNavn;
            card.appendChild(header);
            const list = document.createElement('ul');
            const players = lag.spillere || [];
            if(players.length){
              players.forEach(p => {
                const li = document.createElement('li');
                li.textContent = p;
                list.appendChild(li);
              });
            } else {
              const li = document.createElement('li');
              li.textContent = 'No players';
              list.appendChild(li);
            }
            card.appendChild(list);
            const actions = document.createElement('div');
            actions.className = 'actions';
            const delBtn = document.createElement('button');
            delBtn.textContent = 'Delete';
            delBtn.onclick = (e) => { e.stopPropagation(); slettLag(doc.id); };
            actions.appendChild(delBtn);
            card.appendChild(actions);
            container.appendChild(card);
          });
        })
        .catch(error => console.error('Error fetching teams: ', error));
    }

    function showTab(id, btn){
      document.querySelectorAll('.tab-section').forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      if(btn) btn.classList.add('active');

      if(id === 'teams') {
        closeRefForm();
        const sidebar = document.getElementById('teamSidebar');
        if(sidebar) sidebar.style.display = 'block';
      } else if(id === 'refs') {
        const sidebar = document.getElementById('teamSidebar');
        if(sidebar) sidebar.style.display = 'none';
        openRefereeForm();
      }
    }

function hentDommere() {
  db.collection('turneringer')
    .doc(turneringId)
    .collection('dommere')
    .get()
    .then(snapshot => {
      const container = document.getElementById('dommerListe');
      container.innerHTML = '';
      snapshot.forEach(doc => {
        const data = doc.data();
        const card = document.createElement('div');
        card.className = 'ref-card';
        card.innerHTML = `<h3>${data.dommer}</h3><p>${data.teamName || '—'}</p>`;
        card.addEventListener('click', () => openRefereeForm(doc.id));
        const actions = document.createElement('div');
        actions.className = 'actions';
        const delBtn = document.createElement('button');
        delBtn.textContent = 'Delete';
        delBtn.onclick = (e) => { e.stopPropagation(); deleteReferee(doc.id); };
        actions.appendChild(delBtn);
        card.appendChild(actions);
        container.appendChild(card);
      });
    })
    .catch(console.error);
}

    
    function deleteReferee(dommer){
      db.collection('turneringer').doc(turneringId).collection('dommere').doc(dommer).delete().then(() => {
        console.log('Dommer slettet');
        hentDommere();
      }).catch(error => {
        console.error('Feil ved sletting av dommer:', error);
      });
    }
    
    function toggleUserMenu() {
      const userMenu = document.getElementById('user-menu');
      if (userMenu.style.display === 'none' || userMenu.style.display === '') {
        userMenu.style.display = 'block';
      } else {
        userMenu.style.display = 'none';
      }
    }
    
    document.addEventListener('DOMContentLoaded', function() {
      var menyKnapp = document.getElementById('meny-knapp');
      var meny = document.getElementById('meny');
      menyKnapp.addEventListener('click', function() {
        meny.classList.toggle('meny-åpen');
        menyKnapp.classList.toggle('åpen');
        var erApen = meny.classList.contains('meny-åpen');
        menyKnapp.setAttribute('aria-expanded', erApen);
        if (erApen) {
          menyKnapp.setAttribute('aria-label', 'Lukk meny');
        } else {
          menyKnapp.setAttribute('aria-label', 'Åpne meny');
        }
      });
    });
    
    hentDommere();
  </script>
  
  <!-- Ekstra script for å bevare query-parametere på alle interne lenker -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Gå gjennom alle interne <a>-elementer og legg til "id" parameteren
      if (turneringId) {
        const anchors = document.querySelectorAll('a');
        anchors.forEach(link => {
          let href = link.getAttribute('href');
          // Sjekk at href eksisterer og at det er en relativ lenke
          if (href && !href.startsWith('http') && !href.startsWith('mailto:') && !href.startsWith('#')) {
            const separator = href.includes('?') ? '&' : '?';
            if (!href.includes('id=')) {
              link.setAttribute('href', href + separator + 'id=' + turneringId);
            }
          }
        });
      }
    });
  </script>
</body>
</html>
