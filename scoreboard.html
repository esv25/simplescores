<!DOCTYPE html>
<html lang="no">
<head>
  <script src="https://cdn.tailwindcss.com"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scoreboard</title>
  <meta property="og:title" content="Scoreboard">
  <meta property="og:description" content="Live oppdatering av scorene.">
  <meta property="og:image" content="logo.png">
  <meta property="og:url" content="https://ditt-domene.no/scoreboard.html">
    <link rel="stylesheet" href="scoreboard.css">

</head>
<body>

    <main>
        <!-- Venstre sidepanel -->
        <div class="side-panel left">
            <button id="startBtn">Start</button>
            <button id="stopBtn">Stopp</button>
            <button id="resetBtn">Reset</button>
        </div>
    
        <!-- Hovedinnhold -->
        <div class="scoreboard-container">
            <div class="scoreboard">
                <div class="time-adjust-buttons">
                    <button class="time-button" onclick="adjustTime(60)">+1m</button>
                    <button class="time-button" onclick="adjustTime(-60)">-1m</button>
                    <button class="time-button" onclick="adjustTime(1)">+1s</button>
                    <button class="time-button" onclick="adjustTime(-1)">-1s</button>
                </div>

                <!-- Resten av innholdet forblir uendret -->
                <div class="timeout-timer" id="timeoutTimer" style="display:none;">Timeout: 30s</div>
                <div class="period" id="period">1. omgang</div>
                <div class="scores" id="scoresContainer">
                    <div class="score-section" id="hjemmeSection">
                        <div id="hjemmeScore" class="score">0</div>
                        <div class="team-name" id="hjemmelagNavn">Lag 1</div>
                        <div class="score-controls">
                            <div class="adjust-buttons">
                                <button class="score-button" onclick="openPlayerModal('hjemme','goal')">+</button>
                                <button class="score-button" onclick="adjustScore('hjemmeScore', -1, 'hjemme')">-</button>
                            </div>
                            <button class="time-button" onclick="startTimeout('hjemme')">Timeout</button>
                            <button class="time-button yellow-button" style="display:none;" onclick="openPlayerModal('hjemme','yellow')">Gult kort</button>
                            <button class="time-button red-button" style="display:none;" onclick="openPlayerModal('hjemme','red')">Rødt kort</button>
                            <button class="time-button penalty-button" style="display:none;" onclick="openPlayerModal('hjemme','penalty')">2&nbsp;min</button>
                        </div>
                        <div id="hjemmeCards" class="card-display"></div>
                        <div id="hjemmePenalties" class="penalty-display"></div>
                    </div>
                    <div class="timer" id="timer">15:00</div>
                    <div class="score-section" id="borteSection">
                        <div id="borteScore" class="score">0</div>
                        <div class="team-name" id="bortelagNavn">Lag 2</div>
                        <div class="score-controls">
                            <div class="adjust-buttons">
                                <button class="score-button" onclick="openPlayerModal('borte','goal')">+</button>
                                <button class="score-button" onclick="adjustScore('borteScore', -1, 'borte')">-</button>
                            </div>
                            <button class="time-button" onclick="startTimeout('borte')">Timeout</button>
                            <button class="time-button yellow-button" style="display:none;" onclick="openPlayerModal('borte','yellow')">Gult kort</button>
                            <button class="time-button red-button" style="display:none;" onclick="openPlayerModal('borte','red')">Rødt kort</button>
                            <button class="time-button penalty-button" style="display:none;" onclick="openPlayerModal('borte','penalty')">2&nbsp;min</button>
                        </div>
                        <div id="borteCards" class="card-display"></div>
                        <div id="bortePenalties" class="penalty-display"></div>
                    </div>
                </div>
            </div>
        </div>
    
<!-- Høyre sidepanel -->
<!-- Høyre sidepanel -->
<!-- Høyre sidepanel -->
<div class="side-panel right">
  <button id="overviewBtn"
          class="time-button"
          onclick="openOverview()">
      Kampoversikt
  </button>

  <button id="switchSidesBtn" class="time-button"
          onclick="switchSides()">Bytt Side</button>

  <button id="cancelTimeoutBtn" class="time-button"
          onclick="cancelBreak()" style="display:none;">
      Avbryt Timeout/Pause
  </button>
</div>


    </main>        

    <!-- Modal for Målregistrering -->
    <div id="playerModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2 id="modalTitle">Velg spiller</h2>
            <ul id="playerList" class="player-list"></ul>
        </div>
    </div>
<!-- Modal for utslagsavklaring -->
<!-- Modal for utslagsavklaring -->
<div id="knockoutModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeKnockoutModal()">&times;</span>
      <h2>Kampen er uavgjort!</h2>
      <p>Velg metode for å avgjøre kampen:</p>
      <div class="method-buttons" style="display: flex; justify-content: space-around; margin-top:1rem;">
        <button id="btnExtra" class="time-button">Ekstraomganger</button>
        <button id="btnPenalties" class="time-button">Straffespark</button>
      </div>
      <!-- Ekstraomgang-input -->
      <div id="extraInputContainer" style="display:none; margin-top:1rem; text-align:center;">
        <label for="extraTimeInput">Ekstra tid (sek):</label>
        <input type="number" id="extraTimeInput" min="1" placeholder="f.eks. 300" />
        <button id="confirmExtra" class="time-button">Start ekstraomgang</button>
      </div>
      <!-- Straffespark-input -->
      <div id="penaltyInputContainer" style="display:none; margin-top:1rem; text-align:center;">
        <label for="penaltyCountInput">Antall straffer per lag:</label>
        <input type="number" id="penaltyCountInput" min="1" placeholder="f.eks. 5" />
        <button id="confirmPenalties" class="time-button">Start straffekonkurranse</button>
      </div>
    </div>
  </div>
<!-- Fancy Straffesparkkonkurranse Modal -->
<div id="penaltyModal" class="modal">
    <div class="modal-content penalty">
      <span class="close" onclick="closePenaltyModal()">&times;</span>
      <h2>Straffesparkkonkurranse</h2>
      <div class="penalty-ui">
        <div class="team-panel">
          <div class="team-name" id="homeName">Lag 1</div>
          <div class="dot-container" id="homeDots"></div>
        </div>
        <div class="control-panel">
          <div id="currentShooter">Lag 1 skal skyte</div>
          <button class="penalty-btn" id="btnMiss">Bom</button>
          <button class="penalty-btn" id="btnScore">Treff</button>
        </div>
        <div class="team-panel">
          <div class="team-name" id="awayName">Lag 2</div>
          <div class="dot-container" id="awayDots"></div>
        </div>
  </div>
  <button id="confirmPenaltyResults" class="time-button">Fullfør konkurranse</button>
    </div>
  </div>
<!-- Modal for neste kamp -->
<div id="nextMatchModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeNextMatchModal()">&times;</span>
    <h2>Neste kamp på banen</h2>
    <p id="nextMatchInfo">Ingen flere kamper.</p>
    <div class="next-match-actions">
      <button id="goToNextMatchBtn" class="time-button">Gå til neste kamp</button>
    </div>
  </div>
</div>
  
  
    <!-- Firebase SDKs og JavaScript-kode -->
    <script src="https://www.gstatic.com/firebasejs/8.2.0/firebase-app.js"></script>
    <script src="firebaseConfig.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.0/firebase-database.js"></script>

    <script>

        // Initialiser Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
const rtdb = firebase.database();                                  // <-- Nytt


        const auth = firebase.auth();
                          
        auth.onAuthStateChanged((user) => {
        if (user) {
            const email = user.email;
            document.getElementById('mail') && (document.getElementById('mail').innerHTML = email);
        } else {
            // Ingen bruker er logget inn, redirect til innloggingssiden
            window.location.href = 'login.html';
        }
        });


        const params = new URLSearchParams(window.location.search);
        const turneringId = params.get('id');
        const isManual   = params.get('manual') === '1';
  // Hent turnerings-ID fra URL-querystring
  document.addEventListener('DOMContentLoaded', function() {



      // Gå gjennom alle interne <a>-lenker og legg til query-parametere om de ikke allerede har en "id" parameter
      const links = document.querySelectorAll('a');
      links.forEach(link => {
          let href = link.getAttribute('href');
          // Bare behandle relative lenker (ikke absolute, mailto: eller ankre)
          if (href && !href.startsWith('http') && !href.startsWith('mailto:') && !href.startsWith('#')) {
              if (!href.includes('id=')) {
                  href += (href.includes('?') ? '&' : '?') + 'id=' + turneringId;
              }
              if (isManual && !href.includes('manual=')) {
                  href += (href.includes('?') ? '&' : '?') + 'manual=1';
              }
              link.setAttribute('href', href);
          }
      });
  });
       

        // Hent kampId fra URL
        const urlParams = new URLSearchParams(window.location.search);
        const kampId = decodeURIComponent(urlParams.get('kampId'));

        console.log('Kamp ID:', kampId);
        const clockRef = rtdb.ref(`games/${turneringId}/kamper/${kampId}/remainingTime`);  // <-- Ny referanse
        // Variabler for å holde styr på omgang og tid
        let timeLeft; // Vil bli satt fra innstillinger
        let currentPeriod = 1;
        let timerInterval;
        let timeoutActive = false;  // Variabel for å spore om en timeout/pause er aktiv
        let timeoutDuration; // Timeout-lengde, satt fra innstillingene
let pauseDuration;   // Pauselengde, satt fra innstillingene
        let numPeriods; // Antall perioder, vil bli satt fra innstillinger
        let timeBegin;
        let storedTimeLeft; // For å lagre tiden før timeout
        let originalTimeLeft; // For å lagre tiden før timeout start
        let logGoalScorersEnabled = true; // Kan deaktiveres via innstillinger
        let logYellowCardsEnabled = false;
        let logRedCardsEnabled    = false;
        let logPenaltiesEnabled   = false;
        // Holder aktive utvisningstimere for hvert lag
        // Hver oppføring er et objekt { remaining, interval, item, span }
        const activePenalties = { hjemme: [], borte: [] };
        // Global variabel for kampens fase – "utslag" for utslagskamper
let matchPhase;

        // Variabel for å holde styr på hvilket lag som er i timeout
        let currentTimeoutTeam = null;

        // Initialiser kampdata
        hentKampData(kampId);

        // Hent kampdata fra Firestore
       // 1) Hent kampdata og sett matchPhase
       /**
 * Navigerer til kampoversikt-siden og beholder ?id= i URL-en.
 */
function openOverview() {
  const target = isManual
    ? (turneringId ? `manualMatches.html?id=${turneringId}&manual=1`
                   : 'manualMatches.html')
    : (turneringId ? `kamper.html?id=${turneringId}`
                   : 'kamper.html');
  window.location.href = target;
}

async function hentKampData(kampId) {
  try {
    const kampDoc = await db.collection('turneringer').doc(turneringId)
                            .collection('kamper').doc(kampId).get();

    if (kampDoc.exists) {
      const kampData = kampDoc.data();

      // **Sett fasen** (f.eks. "utslag")
      matchPhase = kampData.fase;

      // Hvis remainingTime er lagret som "mm:ss"
      if (kampData.remainingTime) {
        const parts = kampData.remainingTime.split(':');
        if (parts.length === 2) {
          timeLeft = parseInt(parts[0], 10) * 60
                   + parseInt(parts[1], 10);
        }
      } else {
        // Standardverdi: 15 minutter
        timeLeft = 15 * 60;
      }

      // Tving currentPeriod til å være et tall
      currentPeriod = parseInt(kampData.currentPeriod, 10) || 1;

      visScoreboard(kampData);
      updateTimerDisplay();
      hentInnstillinger(kampData.divisjon);
    } else {
      console.error('Ingen kamp funnet med ID:', kampId);
    }
  } catch (error) {
    console.error('Feil ved henting av kampdata:', error);
  }
}

async function hentInnstillinger(division) {
    try {
        const settingsDoc = await db.collection('turneringer')
                                    .doc(turneringId)
                                    .collection('settings')
                                    .doc(division)
                                    .get();
        
        if (settingsDoc.exists) {
            const settings = settingsDoc.data();
            console.log("Innstillinger hentet:", settings);
            numPeriods     = parseInt(settings.numPeriods, 10)     || 2;
            timeLeft       = parseInt(settings.halfDuration, 10) * 60 || 900;
            timeBegin      = timeLeft;  // vi bruker samme verdi til restart
            timeoutDuration = parseInt(settings.timeoutDuration, 10) || 30;
            pauseDuration   = parseInt(settings.pauseDuration, 10)   || 60;
            logGoalScorersEnabled =
                settings.logGoalScorers === undefined ? true
                                                     : Boolean(settings.logGoalScorers);
            logYellowCardsEnabled = Boolean(settings.logYellowCards);
            logRedCardsEnabled    = Boolean(settings.logRedCards);
            logPenaltiesEnabled   = Boolean(settings.logPenalties);
            console.log("pauseDuration satt til:", pauseDuration);

        } else {
            console.error('Ingen innstillinger funnet for divisjon:', division);
            // Fallback-verdier:
            numPeriods      = 2;
            timeLeft        = 900;
            timeBegin       = 900;
            timeoutDuration = 30;
            pauseDuration   = 60;
            logYellowCardsEnabled = false;
            logRedCardsEnabled    = false;
            logPenaltiesEnabled   = false;
        }
    } catch (error) {
        console.error('Feil ved henting av innstillinger:', error);
        // Fallback-verdier:
        numPeriods      = 2;
        timeLeft        = 900;
        timeBegin       = 900;
        timeoutDuration = 30;
        pauseDuration   = 60;
        logYellowCardsEnabled = false;
        logRedCardsEnabled    = false;
        logPenaltiesEnabled   = false;
    }

    // --- OPPDATER UI HER ---
    // Timer-visning
    const minutter = Math.floor(timeLeft / 60);
    const sekunder = timeLeft % 60;
    document.getElementById('timer').textContent =
      `${minutter.toString().padStart(2,'0')}:${sekunder.toString().padStart(2,'0')}`;

    // Periodetekst
    document.getElementById('period').textContent = `${currentPeriod}. omgang`;

    document.querySelectorAll('.yellow-button').forEach(btn => {
        btn.style.display = logYellowCardsEnabled ? 'block' : 'none';
    });
    document.querySelectorAll('.red-button').forEach(btn => {
        btn.style.display = logRedCardsEnabled ? 'block' : 'none';
    });
    document.querySelectorAll('.penalty-button').forEach(btn => {
        btn.style.display = logPenaltiesEnabled ? 'block' : 'none';
    });
}




        function visScoreboard(kampData) {
            // Initialize scores
            document.getElementById('hjemmeScore').textContent = kampData.hjemmelagScore || 0;
            document.getElementById('borteScore').textContent = kampData.bortelagScore || 0;

            // Update team names
            document.getElementById('hjemmelagNavn').textContent = kampData.hjemmelag || "Lag 1";
            document.getElementById('bortelagNavn').textContent = kampData.bortelag || "Lag 2";

            // Log to check if kampData contains the correct fields
            console.log("Kamp Data:", kampData);
            console.log("Hjemmelag:", kampData.hjemmelag);
            console.log("Bortelag:", kampData.bortelag);
        }

        function adjustScore(scoreId, delta, team) {
    const scoreElement = document.getElementById(scoreId);
    let currentScore = parseInt(scoreElement.textContent) || 0;
    currentScore = Math.max(0, currentScore + delta); // Avoid negative score
    scoreElement.textContent = currentScore;

    // Update the score in Firestore
    const field = team === 'hjemme' ? 'hjemmelagScore' : 'bortelagScore';
    db.collection('turneringer').doc(turneringId).collection('kamper').doc(kampId).update({
        [field]: currentScore // Use the new currentScore instead of increment
    })
    .then(() => {
        console.log(`Score oppdatert for ${team}: ${currentScore}`);
    })
    .catch(error => {
        console.error(`Feil ved oppdatering av score for ${team}:`, error);
    });
}


        // Funksjon for å justere tid
        function adjustTime(seconds) {
            timeLeft = Math.max(0, timeLeft + seconds);  // Sørg for at tiden ikke går under 0
            updateTimer();  // Oppdater timeren på skjermen og i Firebase
        }

      // 2) Oppdatert updateTimer med sjekk for uavgjort i utslagskamper
function updateTimer() {
  // Oppdater visningen av tiden
  const minutes = Math.floor(timeLeft / 60);
  const seconds = timeLeft % 60;
  const formattedTime = `${minutes.toString().padStart(2, '0')
                      }:${seconds.toString().padStart(2, '0')}`;
  document.getElementById("timer").textContent = formattedTime;

  // Oppdater Firestore med currentPeriod som et tall
  clockRef.set(formattedTime)                              // skriver bare klokke
  .catch(err => console.error("Feil i RTDB set:", err));

// Hvis du også vil lagre period, gjør multi-path update:
rtdb.ref(`games/${turneringId}/kamper/${kampId}`).update({
  remainingTime: formattedTime,
  currentPeriod: currentPeriod
})
.catch(err => console.error("Feil i RTDB update:", err));

  // Når tiden går til 0 og vi ikke er i pause:
  if (!inPause && timeLeft === 0) {
    clearInterval(timerInterval);

    // Hvis vi fortsatt har ordinære omganger igjen, gå til pause
    if (currentPeriod < numPeriods) {
      inPause = true;
      timeLeft = pauseDuration;
      document.getElementById("period").textContent = "Pause";
      switchSides();
      startPauseTimer();

    } else {
      // Etter siste ordinære omgang: sjekk uavgjort i utslagskamp
      const hjemmeScore = parseInt(
        document.getElementById("hjemmeScore").textContent, 10
      ) || 0;
      const borteScore = parseInt(
        document.getElementById("borteScore").textContent, 10
      ) || 0;

      if (matchPhase === "utslag" && hjemmeScore === borteScore) {
        // Åpne modal for valg av ekstraomganger eller straffer
        openKnockoutModal();
      } else {
        // Avslutt kampen normalt
        document.getElementById("period").textContent = "Kamp avsluttet";
        avsluttKamp();
      }
    }
  }
}




function openKnockoutModal() {
    document.getElementById('knockoutModal').style.display = 'block';
}

function closeKnockoutModal() {
    document.getElementById('knockoutModal').style.display = 'none';
}


function startNextPeriod() {
    currentPeriod++;
    console.log("Starter neste omgang. Ny currentPeriod:", currentPeriod);
    timeLeft = timeBegin || 900; 
    document.getElementById('period').textContent = `${currentPeriod}. omgang`;
    updateTimerDisplay();

}

// Globale variabler for break-håndtering
let breakActive = false;
let activeBreakInterval = null;
let breakType = null; // "timeout" eller "pause"
function startTimeout(team) {
  if (breakActive) return;
  // Bruk eksisterende originalTimeLeft-variabel og tilordne den nye verdien
  originalTimeLeft = timeLeft; 
  breakActive = true;
  breakType = "timeout";
  currentTimeoutTeam = team;
  let timeoutTimeLeft = timeoutDuration; 
  stopTimer();

  document.getElementById('cancelTimeoutBtn').style.display = 'block';
  document.getElementById('startBtn').style.display = 'none';
  document.getElementById('stopBtn').style.display = 'none';

  const timeoutFieldRemaining = team === 'hjemme' ? 'hjemmeTimeoutRemaining' : 'borteTimeoutRemaining';
  db.collection('turneringer').doc(turneringId)
    .collection('kamper').doc(kampId).update({
      [timeoutFieldRemaining]: timeoutDuration
    })
    .then(() => {
      console.log(`Timeout startet for ${team}: ${timeoutDuration} sekunder`);
      document.getElementById('timeoutTimer').textContent = `Timeout: ${timeoutTimeLeft}s`;
      document.getElementById('timeoutTimer').style.display = 'block';
    })
    .catch(error => {
      console.error(`Feil ved oppdatering av timeout for ${team}:`, error);
    });

  activeBreakInterval = setInterval(() => {
    timeoutTimeLeft--;
    document.getElementById("timeoutTimer").textContent = `Timeout: ${timeoutTimeLeft}s`;

    if (timeoutTimeLeft <= 0) {
      clearInterval(activeBreakInterval);
      breakActive = false;
      breakType = null;
      currentTimeoutTeam = null;
      document.getElementById('cancelTimeoutBtn').style.display = 'none';
      document.getElementById('startBtn').style.display = 'block';
      document.getElementById('stopBtn').style.display = 'block';

      db.collection('turneringer').doc(turneringId)
        .collection('kamper').doc(kampId).update({
          [timeoutFieldRemaining]: 0   // Oppdater med et gyldig tall (ikke undefined)
        })
        .then(() => {
          console.log(`Timeout fullført for ${team}`);
          document.getElementById('timeoutTimer').style.display = 'none';
        })
        .catch(error => {
          console.error(`Feil ved oppdatering av fullført timeout for ${team}:`, error);
        });

    }
  }, 1000);
}
function startPauseTimer() {
  if (breakActive) return;
  originalTimeLeft = timeLeft; 
  breakActive = true;
  breakType = "pause";

  document.getElementById('cancelTimeoutBtn').style.display = 'block';

  activeBreakInterval = setInterval(() => {
    if (timeLeft > 0) {
      timeLeft--;
      updateTimerDisplay();
    } else {
      clearInterval(activeBreakInterval);
      breakActive = false;
      breakType = null;
      document.getElementById('cancelTimeoutBtn').style.display = 'none';

      // Sett inPause tilbake til false
      inPause = false;

      // Start neste omgang automatisk
      startNextPeriod();  // ← Denne linjen må fjernes eller kommenteres ut :contentReference[oaicite:0]{index=0}:contentReference[oaicite:1]{index=1}
    }
  }, 1000);
}


// Global flaggvariabel for å hindre at updateTimer trigges automatisk rett etter avbrudd
let justCanceledBreak = false;
let inPause = false;  // Global variabel som indikerer om vi er i pause

async function cancelBreak() {
  if (!breakActive) return;

  // Stopp break‑intervallene (timeout eller pause)
  clearInterval(activeBreakInterval);

  const wasTimeout = (breakType === "timeout");

  // Nullstill break‑variabler og knappvisninger
  breakActive = false;
  breakType = null;
  document.getElementById('cancelTimeoutBtn').style.display = 'none';
  document.getElementById('startBtn').style.display = 'block';
  document.getElementById('stopBtn').style.display = 'block';
  document.getElementById('timeoutTimer').style.display = 'none';

  // Hvis det var en timeout, sett timeout‑feltet til 0 i Firestore
  if (wasTimeout && currentTimeoutTeam) {
    const timeoutField = currentTimeoutTeam === 'hjemme'
      ? 'hjemmeTimeoutRemaining'
      : 'borteTimeoutRemaining';
    try {
      await db.collection('turneringer').doc(turneringId)
              .collection('kamper').doc(kampId)
              .update({ [timeoutField]: 0 });
    } catch (error) {
      console.error('Feil ved oppdatering av timeout remaining time:', error);
    }
  }
  currentTimeoutTeam = null;

  // Håndter pause vs. timeout
  if (wasTimeout) {
    // Gjenoppta tiden før timeout
    timeLeft = originalTimeLeft;
    updateTimerDisplay();
    justCanceledBreak = true;
    setTimeout(() => { justCanceledBreak = false; }, 500);
  } else {
    // Det var en pause – gå til neste omgang
    startNextPeriod();
    inPause = false;  // <-- Viktig: sørg for å nullstille pause‑flagget
  }
}


// Hjelpefunksjon: Oppdater gruppestatistikk for et lag i en kamp
function oppdaterStatistikkForLag(gruppeStat, kamp) {
    const hjemmelag = kamp.hjemmelag;
    const bortelag = kamp.bortelag;
    // Initialiser laget i gruppestatistikken om nødvendig
    if (!gruppeStat[hjemmelag]) {
        gruppeStat[hjemmelag] = { lagNavn: hjemmelag, poeng: 0, målScoret: 0, målSluppetInn: 0 };
    }
    if (!gruppeStat[bortelag]) {
        gruppeStat[bortelag] = { lagNavn: bortelag, poeng: 0, målScoret: 0, målSluppetInn: 0 };
    }
    const hjemmelagScore = kamp.hjemmelagScore || 0;
    const bortelagScore = kamp.bortelagScore || 0;
    // Oppdater poeng for vinner eller ved uavgjort
    if (hjemmelagScore > bortelagScore) {
        gruppeStat[hjemmelag].poeng += 3;
    } else if (hjemmelagScore < bortelagScore) {
        gruppeStat[bortelag].poeng += 3;
    } else {
        gruppeStat[hjemmelag].poeng += 1;
        gruppeStat[bortelag].poeng += 1;
    }
    // Oppdater målscoret og mål sluppet inn
    gruppeStat[hjemmelag].målScoret += hjemmelagScore;
    gruppeStat[hjemmelag].målSluppetInn += bortelagScore;
    gruppeStat[bortelag].målScoret += bortelagScore;
    gruppeStat[bortelag].målSluppetInn += hjemmelagScore;
}
async function avsluttKamp() {
  console.log("avsluttKamp() called for kampId:", kampId);
  let kampData;

  // --- 1) Stopp timere/pause ---
  clearInterval(timerInterval);
  clearInterval(activeBreakInterval);

  // --- 2) Oppdater UI ---
  document.getElementById('period').textContent = 'Kamp avsluttet';
  document.getElementById('timer').textContent  = '00:00';

  try {
    // --- 3) Hent kampdata ---
    const kampRef  = db.collection('turneringer')
                       .doc(turneringId)
                       .collection('kamper')
                       .doc(kampId);
    const kampSnap = await kampRef.get();
    if (!kampSnap.exists) {
      alert("Feil: Kampen ble ikke funnet.");
      return;
    }
    kampData = kampSnap.data();
    console.log("  Kamp data fra Firestore:", kampData);

    // --- 4) Marker ferdig ---
    await kampRef.update({
      status: 'ferdig',
      remainingTime: '00:00',
      currentPeriod,
      avslutningstidspunkt: new Date().toISOString()
    });

    // --- 5) Finn riktig faseType ---
    const phaseType = kampData.faseType ?? kampData.fasetype;
    console.log("  Detektert faseType:", phaseType);

    // --- 6a) Gruppespill? ---
    if (phaseType === 'gruppespill') {
      // … eksisterende gruppespill-logikk …
    }
    // --- 6b) Utslag? ---
    else if (phaseType === 'utslag') {
      // Rundenummer er ofte heltall, men kan ligge i rundeNummer eller runde
      const currentRound = parseInt(
        kampData.rundeNummer ?? kampData.runde ?? kampData.rundenummer,
        10
      );
      console.log("  Kjører oppdaterNesteUtslagsrunde for runde:", currentRound);
      try {
        await oppdaterNesteUtslagsrunde(currentRound, kampData);
        console.log("  oppdaterNesteUtslagsrunde ferdig");
      } catch (err) {
        console.error("  Feil i oppdaterNesteUtslagsrunde:", err);
      }
    }
    // --- 6c) Ukjent faseType ---
    else {
      console.warn("  Ukjent faseType – ingen oppdatering kjøres");
    }

  } catch (error) {
    console.error("Feil ved avslutning av kamp:", error);
    alert("En feil oppstod under avslutningen av kampen.");
    return;
  }

  // --- 7) Ferdig ---
  const nextMatch = kampData
    ? await hentNesteKampPaBane(kampData.bane, kampData.starttid)
    : null;
  showNextMatchPopup(nextMatch);
  alert("Kampen er avsluttet.");
  console.log("avsluttKamp() ferdig.");
}

async function hentNesteKampPaBane(bane, starttid) {
  try {
    const snap = await db.collection('turneringer')
      .doc(turneringId)
      .collection('kamper')
      .where('bane', '==', bane)
      .get();

    const docs = snap.docs.slice().sort((a, b) => {
      const aDate = a.data().starttid?.toDate
        ? a.data().starttid.toDate()
        : new Date(a.data().starttid);
      const bDate = b.data().starttid?.toDate
        ? b.data().starttid.toDate()
        : new Date(b.data().starttid);
      return aDate - bDate;
    });

    const startMs = starttid?.toDate ? starttid.toDate().getTime()
                                   : new Date(starttid).getTime();
    let next = null;
    docs.forEach(doc => {
      const d = doc.data();
      const ts = d.starttid?.toDate ? d.starttid.toDate().getTime()
                                    : new Date(d.starttid).getTime();
      if (ts > startMs && (!next || ts < (next.starttid?.toDate
            ? next.starttid.toDate().getTime()
            : new Date(next.starttid).getTime()))) {
        next = { id: doc.id, ...d };
      }
    });
    return next;
  } catch (err) {
    console.error('Feil ved henting av neste kamp:', err);
    return null;
  }
}

function showNextMatchPopup(match) {
  const modal = document.getElementById('nextMatchModal');
  const info  = document.getElementById('nextMatchInfo');
  const btn   = document.getElementById('goToNextMatchBtn');
  if (match) {
    const start = match.starttid?.toDate ? match.starttid.toDate()
                                         : new Date(match.starttid);
    const time  = start.toLocaleTimeString('no-NO', { hour: '2-digit', minute: '2-digit' });
    info.textContent = `${match.hjemmelag} vs ${match.bortelag} kl. ${time}`;
    btn.style.display = 'inline-block';
    btn.onclick = () => {
      let url = `scoreboard.html?kampId=${encodeURIComponent(match.id)}&id=${turneringId}`;
      if (isManual) url += '&manual=1';
      window.location.href = url;
    };
  } else {
    info.textContent = 'Ingen flere kamper på denne banen.';
    btn.style.display = 'none';
  }
  modal.style.display = 'block';
}

function closeNextMatchModal() {
  document.getElementById('nextMatchModal').style.display = 'none';
}

async function oppdaterNesteUtslagsrunde(currentRound, kampData) {
  console.log("[oppdaterNesteUtslagsrunde] ► Start", { currentRound, kampData });

  const dbRef = db.collection('turneringer').doc(turneringId);
  const formatColl = dbRef.collection(`${kampData.divisjon}_format`);

  // Ny struktur: formatdokumentet for fasen inneholder segmenter
  const faseDoc = await formatColl.doc(kampData.fase).get();
  let utslagsrunder;
  if (faseDoc.exists) {
    const data = faseDoc.data();
    if (Array.isArray(data.segmenter)) {
      const seg = data.segmenter.find(s => s.type === 'utslag');
      if (seg && seg.utslagsrunder) {
        utslagsrunder = seg.utslagsrunder;
      }
    }
    if (!utslagsrunder) {
      // Fallback: gammel struktur
      utslagsrunder = data.utslagsrunder;
    }
  }

  // Ekstra fallback: søk etter et dokument med type=="utslag" (gammel modell)
  if (!utslagsrunder) {
    const fmtSnap = await formatColl
      .where('type', '==', 'utslag')
      .limit(1)
      .get();
    if (fmtSnap.empty) {
      console.warn("[oppdaterNesteUtslagsrunde] ⚠ Ingen utslags-format funnet");
      return;
    }
    utslagsrunder = fmtSnap.docs[0].data().utslagsrunder;
  }

  if (!Array.isArray(utslagsrunder)) {
    console.warn("[oppdaterNesteUtslagsrunde] ⚠ 'utslagsrunder' mangler i format");
    return;
  }
  console.log("  utslagsrunder.length:", utslagsrunder.length);

  // Indekser i skjemaet
  const prevRoundIdx = currentRound;
  const nextRoundIdx = currentRound + 1;
  const nextDef      = utslagsrunder[nextRoundIdx];
  if (!nextDef || !Array.isArray(nextDef.kamper)) {
    console.error(`[oppdaterNesteUtslagsrunde] ✖ Ingen kamper i utslagsrunder[${nextRoundIdx}]`);
    return;
  }
  console.log("  nextDef:", nextDef);

  const idx = parseInt(kampData.kampNummer, 10);
  const winnerPlaceholder = `vinner-runde-${prevRoundIdx}-kamp-${idx}`;
  const loserPlaceholder  = `taper-runde-${prevRoundIdx}-kamp-${idx}`;
  console.log("  Placeholders →", winnerPlaceholder, loserPlaceholder);

  // Finn ut hvem som vant/tapte
  const thisWinner = (kampData.tieBreakType === 'penalties')
    ? ((kampData.homePenaltyScore||0) > (kampData.awayPenaltyScore||0)
       ? kampData.hjemmelag : kampData.bortelag)
    : (kampData.hjemmelagScore > kampData.bortelagScore
       ? kampData.hjemmelag : kampData.bortelag);
  const thisLoser = thisWinner === kampData.hjemmelag
    ? kampData.bortelag
    : kampData.hjemmelag;
  console.log("  thisWinner:", thisWinner, "thisLoser:", thisLoser);

  // Hjelper som prøver alle kombinasjoner av feltnavn for fase og runde
  async function oppdaterPlaceholder(placeholder, lagNavn) {
    const phaseFields = ['faseType','fasetype'];
    const roundFields = ['rundeNummer','rundenummer'];
    const sides       = ['hjemmelag','bortelag'];

    for (const phaseField of phaseFields) {
      for (const roundField of roundFields) {
        for (const side of sides) {
          console.log(
            `    Prøver query: { ${phaseField}=='utslag', `+
            `${roundField}==${nextRoundIdx}, ${side}=='${placeholder}' }`
          );
          const snap = await dbRef.collection('kamper')
            .where(phaseField, '==', 'utslag')
            .where(roundField, '==', nextRoundIdx)
            .where(side,        '==', placeholder)
            .limit(1)
            .get();
          console.log("      Treff:", snap.size);
          if (!snap.empty) {
            const doc = snap.docs[0];
            console.log(
              `      Oppdaterer dokument ${doc.id}: setter ${side}='${lagNavn}'`
            );
            await doc.ref.update({ [side]: lagNavn });
            return true;
          }
        }
      }
    }

    console.warn(`    Ingen kamp funnet for placeholder='${placeholder}'`);
    return false;
  }

  // Løp gjennom alle kamp-definisjonene
  for (const [defIdx, def] of nextDef.kamper.entries()) {
    console.log(`  → def[${defIdx}]=`, def);
    if (def.lag1 === winnerPlaceholder) {
      await oppdaterPlaceholder(winnerPlaceholder, thisWinner);
    } else if (def.lag1 === loserPlaceholder) {
      await oppdaterPlaceholder(loserPlaceholder,  thisLoser);
    }
    if (def.lag2 === winnerPlaceholder) {
      await oppdaterPlaceholder(winnerPlaceholder, thisWinner);
    } else if (def.lag2 === loserPlaceholder) {
      await oppdaterPlaceholder(loserPlaceholder,  thisLoser);
    }
  }

  console.log("[oppdaterNesteUtslagsrunde] ► Ferdig");
}



/**
 * Sorterer lagstatistikk etter poeng, målforskjell, scorede mål og navn.
 */
 function sorterLagEtterPlassering(stat) {
  return Object.values(stat).sort((a, b) => {
    // 1) Poeng
    if (b.poeng !== a.poeng) return b.poeng - a.poeng;
    // 2) Målforskjell
    const diffA = a.målScoret - a.målSluppetInn;
    const diffB = b.målScoret - b.målSluppetInn;
    if (diffB !== diffA) return diffB - diffA;
    // 3) Scorede mål
    if (b.målScoret !== a.målScoret) return b.målScoret - a.målScoret;
    // 4) Alfabetisk
    return a.lagNavn.localeCompare(b.lagNavn);
  });
}

async function oppdaterNesteFasePlassholdere(prevPhaseNumber, divisjon) {
  const dbRef      = db.collection('turneringer').doc(turneringId);
  const formatColl = `${divisjon}_format`;

  // 1) Hent og sorter alle faser etter fasenummer
  const fasesnap = await dbRef.collection(formatColl).get();
  const faser = fasesnap.docs
    .map(d => {
      const data = d.data();
      const num = typeof data.fasenummer === 'number'
        ? data.fasenummer
        : (d.id === 'utslag' ? Infinity : parseInt(d.id.replace('fase',''), 10));

      let type    = data.type;
      let grupper = data.grupper || {};
      if (Array.isArray(data.segmenter)) {
        const seg = data.segmenter.find(s => s.type);
        if (seg) {
          type    = seg.type || type;
          grupper = seg.grupper || grupper;
        }
      }

      return { id: d.id, fasenummer: num, type, grupper };
    })
    .sort((a, b) => a.fasenummer - b.fasenummer);

  // 2) Finn forrige og neste fase
  const idx = faser.findIndex(f => f.fasenummer === prevPhaseNumber);
  if (idx < 0 || idx === faser.length - 1) return;
  const prevFase = faser[idx];
  const nesteFase = faser[idx + 1];

  // 3) Bygg gruppeTabeller kun hvis forrige fase var gruppespill
  const gruppeTabeller = {};
  if (prevFase.type === 'gruppespill') {
    // Hent alle kamper i prevFase
    const prevSnap = await dbRef.collection('kamper')
      .where('fase', '==', prevFase.id)
      .get();

    // Beregn ny statistikk
    const gruppeStat = {};
    prevSnap.docs.forEach(doc => {
      const k = doc.data();
      const home = k.hjemmelag, away = k.bortelag;
      const hs = k.hjemmelagScore || 0, as = k.bortelagScore || 0;

      // Init
      if (!gruppeStat[home]) gruppeStat[home] = { lagNavn: home, poeng: 0, målScoret: 0, målSluppetInn: 0 };
      if (!gruppeStat[away]) gruppeStat[away] = { lagNavn: away, poeng: 0, målScoret: 0, målSluppetInn: 0 };

      // Poengberegning
      if (hs > as) gruppeStat[home].poeng += 3;
      else if (as > hs) gruppeStat[away].poeng += 3;
      else {
        gruppeStat[home].poeng += 1;
        gruppeStat[away].poeng += 1;
      }

      // Målstatistikk
      gruppeStat[home].målScoret     += hs;
      gruppeStat[home].målSluppetInn += as;
      gruppeStat[away].målScoret     += as;
      gruppeStat[away].målSluppetInn += hs;
    });

    // Sorter for hver gruppe
    for (const [grp, lagListe] of Object.entries(prevFase.grupper)) {
      gruppeTabeller[grp] = lagListe
        .map(lag => gruppeStat[lag])
        .filter(e => e)
        .sort((a, b) => {
          if (b.poeng !== a.poeng) return b.poeng - a.poeng;
          const diffA = a.målScoret - a.målSluppetInn;
          const diffB = b.målScoret - b.målSluppetInn;
          if (diffB !== diffA) return diffB - diffA;
          if (b.målScoret !== a.målScoret) return b.målScoret - a.målScoret;
          return a.lagNavn.localeCompare(b.lagNavn);
        });
    }
  }

  // 4) Hent kamper i neste fase og erstatt “x. plass i gruppeY”
  const nesteSnap = await dbRef.collection('kamper')
    .where('fase', '==', nesteFase.id)
    .get();

  const batch = db.batch();
  nesteSnap.docs.forEach(doc => {
    const k   = doc.data();
    const upd = {};

    ['hjemmelag', 'bortelag'].forEach(felt => {
      const v = k[felt];
      const m = typeof v === 'string'
        && v.match(/(\d+)\. plass i (gruppe\w+)/i);
      if (m) {
        const plass   = parseInt(m[1], 10) - 1;
        const grpId   = m[2];  // eks. 'gruppe1'
        const nyttLag = gruppeTabeller[grpId]?.[plass]?.lagNavn;
        if (nyttLag) upd[felt] = nyttLag;
      }
    });

    if (Object.keys(upd).length) {
      batch.update(doc.ref, upd);
    }
  });

  await batch.commit();
}



async function oppdaterNesteFaseFraTabell() {
    try {
        // Hent alle kampene i nåværende fase for å beregne tabellen
        const kamperSnapshot = await db.collection('turneringer')
            .doc(turneringId)
            .collection('kamper')
            .where('fase', '==', currentFase)
            .where('divisjon', '==', kampDivisjon)
            .get();

        if (kamperSnapshot.empty) {
            console.error("Ingen kamper funnet i nåværende fase:", currentFase);
            return;
        }

        // Samle lag og beregn statistikk
        const lagStatistikk = {};
        kamperSnapshot.forEach(doc => {
            const kamp = doc.data();
            const { hjemmelag, bortelag, hjemmelagScore, bortelagScore } = kamp;

            // Initialiser lag hvis de ikke allerede er lagt til
            if (!lagStatistikk[hjemmelag]) lagStatistikk[hjemmelag] = initLagStatistikk(hjemmelag);
            if (!lagStatistikk[bortelag]) lagStatistikk[bortelag] = initLagStatistikk(bortelag);

            // Oppdater statistikk hvis kampen er spilt
            if (hjemmelagScore != null && bortelagScore != null) {
                oppdaterLagStatistikk(lagStatistikk[hjemmelag], hjemmelagScore, bortelagScore, true);
                oppdaterLagStatistikk(lagStatistikk[bortelag], bortelagScore, hjemmelagScore, false);
            }
        });

        // Konverter statistikk til array og sorter basert på regler
        const lagArray = Object.values(lagStatistikk);
        lagArray.forEach(lag => lag.målDifferanse = lag.målScoret - lag.målSluppetInn);

        // Hent sorteringsrekkefølge fra turneringsdokument
        const tournamentDoc = await db.collection('turneringer').doc(turneringId).get();
        const sortingOrder = tournamentDoc.data()?.sortingOrder || ["points", "goalDifference", "goalsScored", "alphabetical"];

        lagArray.sort((a, b) => dynamicSort(a, b, sortingOrder));

        // Hent kampene i neste fase
        const nesteFase = `fase${parseInt(currentFase.replace('fase', ''), 10) + 1}`;
        const nesteFaseKamperSnapshot = await db.collection('turneringer')
            .doc(turneringId)
            .collection('kamper')
            .where('fase', '==', nesteFase)
            .get();

        if (nesteFaseKamperSnapshot.empty) {
            console.error("Ingen kamper funnet i neste fase:", nesteFase);
            return;
        }

        // Oppdater kampene i neste fase med de riktige lagene
        const batch = db.batch();
        nesteFaseKamperSnapshot.docs.forEach((doc, index) => {
            const kamp = doc.data();
            const hjemmelagPlassering = kamp.hjemmelag.match(/(\d+)\. plass/);
            const bortelagPlassering = kamp.bortelag.match(/(\d+)\. plass/);

            if (hjemmelagPlassering && bortelagPlassering) {
                const hjemmelagIndex = parseInt(hjemmelagPlassering[1], 10) - 1;
                const bortelagIndex = parseInt(bortelagPlassering[1], 10) - 1;

                const hjemmelag = lagArray[hjemmelagIndex]?.lagNavn || kamp.hjemmelag;
                const bortelag = lagArray[bortelagIndex]?.lagNavn || kamp.bortelag;

                batch.update(doc.ref, { hjemmelag, bortelag });
            }
        });

        // Utfør batch-oppdateringen
        await batch.commit();
        console.log(`Oppdaterte kampene i neste fase (${nesteFase}) med riktige lag.`);
    } catch (error) {
        console.error("Feil ved oppdatering av neste fase:", error);
    }
}


// Initialiser lagstatistikk
function initLagStatistikk(lagNavn) {
    return {
        lagNavn,
        spilt: 0,
        vunnet: 0,
        uavgjort: 0,
        tapt: 0,
        målScoret: 0,
        målSluppetInn: 0,
        poeng: 0
    };
}

// Oppdater lagstatistikk
function oppdaterLagStatistikk(lag, score, motstanderScore, erHjemme) {
    lag.spilt += 1;
    lag.målScoret += score;
    lag.målSluppetInn += motstanderScore;
    if (score > motstanderScore) {
        lag.vunnet += 1;
        lag.poeng += 3;
    } else if (score < motstanderScore) {
        lag.tapt += 1;
    } else {
        lag.uavgjort += 1;
        lag.poeng += 1;
    }
}

// Dynamisk sortering basert på regler
function dynamicSort(a, b, sortingOrder) {
    for (const criterion of sortingOrder) {
        if (criterion === "points" && b.poeng !== a.poeng) return b.poeng - a.poeng;
        if (criterion === "goalDifference" && b.målDifferanse !== a.målDifferanse) return b.målDifferanse - a.målDifferanse;
        if (criterion === "goalsScored" && b.målScoret !== a.målScoret) return b.målScoret - a.målScoret;
        if (criterion === "alphabetical") return a.lagNavn.localeCompare(b.lagNavn);
    }
    return 0;
}
function updateTimerDisplay() {
  const minutes = Math.floor(timeLeft / 60);
  const seconds = timeLeft % 60;
  const formattedTime = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
  document.getElementById("timer").textContent = formattedTime;

  // Oppdater Firestore med currentPeriod uten å endre den til en streng
  rtdb.ref(`games/${turneringId}/kamper/${kampId}`).update({
  remainingTime: formattedTime,
  currentPeriod: currentPeriod
})
.catch(err => console.error("Feil i RTDB update:", err));

}

/*
  Forutsetter:   
  - firebase.initializeApp(...) er allerede kalt.
  - global variabel `turneringId` er definert (f.eks. const turneringId = 'turn1').
*/

// 1) Funksjon for å skrive gjenstående tid direkte til RTDB
//    Bruk denne om server/administrasjon beregner "remainingTime" og pusher ved hendelser (start, pause, stopp).
function writeRemainingTime(kampId, remainingTime) {
  const rtdb = firebase.database();
  const tidRef = rtdb.ref(`turneringer/${turneringId}/kamper/${kampId}/remainingTime`);
  return tidRef
    .set(remainingTime)
    .then(() => {
      console.log(`Oppdatert remainingTime for kamp ${kampId}: ${remainingTime}`);
    })
    .catch(err => {
      console.error('Feil ved oppdatering av tid i RTDB:', err);
    });
}


// 2) Funksjon for å lese ett start-tidsstempel én gang per kamp,
//    og så kjøre lokal nedtelling hvert sekund uten flere DB-kall.
function startLocalCountdown(kampList) {
  // kampList: Array av objekter: { kampId: string, element: HTMLElement }
  const rtdb = firebase.database();

  kampList.forEach(({ kampId, element }) => {
    const startRef = rtdb.ref(`turneringer/${turneringId}/kamper/${kampId}/startTimestamp`);
    startRef
      .once('value')
      .then(snapshot => {
        const ts = snapshot.val();
        if (!ts) {
          element.textContent = 'Ingen starttid funnet';
          return;
        }
        // Forventet format: ISO-streng fra .toISOString(), eller millisekunder
        const startMs = typeof ts === 'number' ? ts : new Date(ts).getTime();

        // Lokal timer-funksjon
        function updateUI() {
          const now = Date.now();
          const diff = startMs - now;
          if (diff <= 0) {
            element.textContent = 'Kamp startet!';
            clearInterval(intervalId);
            return;
          }
          const minutter = Math.floor(diff / 60000);
          const sekunder = Math.floor((diff % 60000) / 1000);
          element.textContent = `${minutter}m ${sekunder}s`;
        }

        updateUI();
        const intervalId = setInterval(updateUI, 1000);
      })
      .catch(err => {
        console.error(`Kunne ikke hente startTimestamp for kamp ${kampId}:`, err);
        element.textContent = 'Feil ved lasting';
      });
  });
}

        function cancelTimeout() {
            if (!timeoutActive) return;

            clearInterval(timerInterval); // Stopp timeout-timeren
            timeoutActive = false;
            document.getElementById('cancelTimeoutBtn').style.display = 'none';
            document.getElementById('startBtn').style.display = 'block';
            document.getElementById('stopBtn').style.display = 'block';

            // Oppdater Firestore
            if (currentTimeoutTeam) {
                const timeoutFieldRemaining = currentTimeoutTeam === 'hjemme' ? 'hjemmeTimeoutRemaining' : 'borteTimeoutRemaining';
                db.collection('turneringer').doc(turneringId).collection('kamper').doc(kampId).update({
                    [timeoutFieldRemaining]: null
                })
                .then(() => {
                    console.log(`Timeout for ${currentTimeoutTeam} avbrutt.`);
                })
                .catch(error => {
                    console.error('Feil ved oppdatering av timeout remaining time:', error);
                });
            }

            // Gjenopprett kamptiden
            timeLeft = originalTimeLeft; // Bruk tiden før timeout
            updateTimerDisplay();
            document.getElementById('timeoutTimer').style.display = 'none';
            currentTimeoutTeam = null;
        }


        function endPause() {
            timeoutActive = false;
            currentTimeoutTeam = null;
            // Sett opp tidtakeren for neste omgang basert på innstillinger
            timeLeft = timeBegin || 900;  // halfDuration må være definert
            document.getElementById('period').textContent = `${currentPeriod}. omgang`;
            updateTimer(); // Oppdater timeren til korrekt tid uten å starte den
        }

function startTimer() {
  // Sjekk om timeLeft er ugyldig, og sett til standardverdi dersom det er tilfellet
  if (isNaN(timeLeft) || timeLeft === undefined || timeLeft === null) {
    timeLeft = 900; // Standardverdi: 15 minutter (900 sekunder)
  }
  
  // Oppdater status til "startet" i Firestore
  db.collection('turneringer')
    .doc(turneringId)
    .collection('kamper')
    .doc(kampId)
    .update({ status: 'startet' })
    .then(() => console.log('Status oppdatert til startet'))
    .catch(err => console.error('Feil ved oppdatering av status:', err));

  // Fjern eventuell eksisterende timer for å unngå duplisering
  clearInterval(timerInterval);

  // Gjenoppta eventuelle utvisningstimere
  resumePenaltyTimers();

  timerInterval = setInterval(() => {
    if (timeLeft > 0) {
      timeLeft--;
      updateTimer();  // Oppdaterer visningen og eventuelt Firestore
    } else {
      clearInterval(timerInterval); // Avslutt timeren når tiden går ut
      updateTimer();  // Gjør siste oppdatering slik at "00:00" vises
    }
  }, 1000);
}

        function stopTimer() {
            clearInterval(timerInterval); // Stopp timeren
            pausePenaltyTimers();        // Pause utvisningstimere
        }
        async function resetTimer() {
    try {
        // Stopp hovedtimeren og eventuelle timeouts/pausetimere
        clearInterval(timerInterval);
        clearInterval(activeBreakInterval); // Erstatt timeoutInterval med activeBreakInterval
        pausePenaltyTimers();
        Object.keys(activePenalties).forEach(t => {
            activePenalties[t].forEach(p => p.item.remove());
            activePenalties[t] = [];
        });


        // Tilbakestill til første omgang og standard tid (15 min = 900 sekunder)
        currentPeriod = 1;
        timeLeft = 900;
        originalTimeLeft = null;

        // Oppdater visningen for perioden
        document.getElementById('period').textContent = `${currentPeriod}. omgang`;

        // Tilbakestill scoren i displayet (oppdater begge lag hvis nødvendig)
        document.getElementById('hjemmeScore').textContent = 0;
        document.getElementById('borteScore').textContent = 0;

        // Oppdater timerdisplayet med korrekt tid
        updateTimerDisplay();

        // Hent eksisterende score for å kunne trekke poengene fra (hvis nødvendig)
        const kampDoc = await db.collection('turneringer')
            .doc(turneringId)
            .collection('kamper')
            .doc(kampId)
            .get();

        if (kampDoc.exists) {
            const kampData = kampDoc.data();

            const hjemmeScore = kampData.hjemmelagScore || 0;
            const borteScore = kampData.bortelagScore || 0;
            const hjemmelag = kampData.hjemmelag;
            const bortelag = kampData.bortelag;

            // Oppdater Firestore med de tilbakestilte verdiene for kampen
            await db.collection('turneringer').doc(turneringId)
                .collection('kamper').doc(kampId).update({
                    remainingTime: formatTime(timeLeft),
                    currentPeriod: currentPeriod,
                    hjemmelagScore: 0,
                    bortelagScore: 0,
                    hjemmeTimeoutRemaining: null,
                    borteTimeoutRemaining: null,
                    hjemmeTimeouts: 0,
                    borteTimeouts: 0
                });

            // Slett alle mål i "goals"-samlingen for denne kampen (hvis aktuelt)
            const goalsRef = db.collection('turneringer')
                .doc(turneringId)
                .collection('kamper')
                .doc(kampId)
                .collection('goals');
            const goalsSnapshot = await goalsRef.get();

            if (!goalsSnapshot.empty) {
                const batch = db.batch();
                goalsSnapshot.forEach((doc) => {
                    batch.delete(doc.ref);
                });
                await batch.commit();
                console.log('Alle mål ble slettet.');
            } else {
                console.log('Ingen mål å slette.');
            }

            // Oppdater eventuelt andre statistikker via en funksjon for lagstatistikk
            await updateTeamStatsAfterReset(hjemmelag, bortelag, hjemmeScore, borteScore);

            // Nullstill eventuelle UI-elementer for målscorere og spillere
            const scorersList = document.getElementById('playerList'); // eller et annet relevant element
            if (scorersList) {
                scorersList.innerHTML = "<li>Ingen målscorere tilgjengelig.</li>";
            }
            const antallSpillereElement = document.getElementById('antallSpillere'); // eksempelnøkkel – oppdater med riktig id hvis du har et slikt element
            if (antallSpillereElement) {
                antallSpillereElement.textContent = 0;
            }

        } else {
            console.error('Ingen kamp funnet med ID:', kampId);
            alert('Feil: Kampen ble ikke funnet.');
        }
    } catch (error) {
        console.error('Feil under reset:', error);
        alert('En feil oppstod under tilbakestilling av kampen. Vennligst prøv igjen.');
    }
}
async function updateTeamStatsAfterReset(hjemmelag, bortelag, hjemmeScore, borteScore) {
    // Eksempel: Oppdater eventuelle lokale/statistikkfelt i Firestore
    try {
        // Oppdater lagstatistikk i en egen underkolleksjon eller et annet felt
        await db.collection('turneringer').doc(turneringId)
            .collection('lag').doc(hjemmelag).update({
                // Nullstill statistikker for hjemmelaget
                poeng: 0,
                spilt: 0,
                vunnet: 0,
                uavgjort: 0,
                tapt: 0,
                målScoret: 0,
                målSluppetInn: 0
            });
        await db.collection('turneringer').doc(turneringId)
            .collection('lag').doc(bortelag).update({
                // Nullstill statistikker for bortelaget
                poeng: 0,
                spilt: 0,
                vunnet: 0,
                uavgjort: 0,
                tapt: 0,
                målScoret: 0,
                målSluppetInn: 0
            });
        console.log('Lagstatistikk ble tilbakestilt.');
    } catch (error) {
        console.error('Feil under tilbakestilling av lagstatistikk:', error);
    }
}






        // Funksjon for å bytte sider
        function switchSides() {
            const scoresContainer = document.getElementById('scoresContainer');
            const hjemmeSection = document.getElementById('hjemmeSection');
            const borteSection = document.getElementById('borteSection');

            const timerEl = document.getElementById('timer');

            // Plasser borteseksjonen til venstre og hjemmelaget til høyre
            scoresContainer.insertBefore(borteSection, timerEl);
            scoresContainer.appendChild(hjemmeSection);


            // Oppdater Firebase med byttet
            db.collection('turneringer').doc(turneringId).collection('kamper').doc(kampId).update({
                sidesSwitched: true
            });
        }

async function logGoalAndUpdateScore(spiller, team) {
    const minutes = Math.floor(timeLeft / 60);
    const seconds = timeLeft % 60;
    const formattedTime = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

    const goalData = {
        spiller: spiller,
        team: team,
        time: formattedTime,
        period: currentPeriod
    };

    try {
        // Reference to the match document
        const kampRef = db.collection('turneringer').doc(turneringId)
                           .collection('kamper').doc(kampId);

        let updatedHjemmeScore;
        let updatedBorteScore;

        // Run transaction
        await db.runTransaction(async (transaction) => {
            const kampDoc = await transaction.get(kampRef);

            if (!kampDoc.exists) {
                throw new Error("Kampdokumentet eksisterer ikke!");
            }

            const data = kampDoc.data();

            let hjemmeScore = data.hjemmelagScore || 0;
            let borteScore = data.bortelagScore || 0;

            // Increment the score for the team that scored
            if (team === 'hjemme') {
                hjemmeScore += 1;
            } else {
                borteScore += 1;
            }

            // Save the updated scores to variables accessible outside the transaction
            updatedHjemmeScore = hjemmeScore;
            updatedBorteScore = borteScore;

            // Calculate points based on the updated scores
            let hjemmePoints = 0;
            let bortePoints = 0;

            if (hjemmeScore > borteScore) {
                hjemmePoints = 3;
                bortePoints = 0;
            } else if (borteScore > hjemmeScore) {
                hjemmePoints = 0;
                bortePoints = 3;
            } else {
                // Uavgjort (Draw)
                hjemmePoints = 1;
                bortePoints = 1;
            }

            // Update the match document with new scores and points
            transaction.update(kampRef, {
                'hjemmelagScore': hjemmeScore,
                'bortelagScore': borteScore,
                'hjemmePoints': hjemmePoints,
                'bortePoints': bortePoints
            });

            // Add the goal to the goals subcollection
            const goalsRef = kampRef.collection('goals').doc();
            transaction.set(goalsRef, goalData);
        });

        // After transaction completes, update UI elements
        document.getElementById('hjemmeScore').textContent = updatedHjemmeScore;
        document.getElementById('borteScore').textContent = updatedBorteScore;

        console.log('Mål registrert og poeng oppdatert.');
    } catch (error) {
        console.error('Feil ved logging av mål og oppdatering av statistikk:', error);
    }
}

async function logCard(spiller, team, type) {
    const minutes = Math.floor(timeLeft / 60);
    const seconds = timeLeft % 60;
    const formattedTime = `${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;

    const cardData = {
        spiller: spiller,
        team: team,
        type: type,
        time: formattedTime,
        period: currentPeriod
    };
    if (type === 'penalty') {
        cardData.duration = 120;
    }

    try {
        const kampRef = db.collection('turneringer').doc(turneringId)
                           .collection('kamper').doc(kampId);
        await kampRef.collection('cards').add(cardData);
        console.log('Kort registrert');
        updateCardUI(spiller, team, type);
    } catch (error) {
        console.error('Feil ved registrering av kort:', error);
    }
}

function updateCardUI(spiller, team, type) {
    if (type === 'yellow') {
        addCard(team, 'yellow-card', spiller);
    } else if (type === 'red') {
        addCard(team, 'red-card', spiller);
    } else if (type === 'penalty') {
        startPenaltyTimer(team, spiller);
    }
}

function addCard(team, cardClass, spiller) {
    const containerId = team === 'hjemme' ? 'hjemmeCards' : 'borteCards';
    const container = document.getElementById(containerId);
    const span = document.createElement('span');
    span.className = `card ${cardClass}`;
    span.textContent = spiller;
    container.appendChild(span);
}

function startPenaltyTimer(team, spiller) {
    const containerId = team === 'hjemme' ? 'hjemmePenalties' : 'bortePenalties';
    const container = document.getElementById(containerId);
    const item = document.createElement('div');
    item.className = 'penalty-item';
    item.textContent = spiller + ':';
    const span = document.createElement('span');
    span.className = 'penalty-time';
    item.appendChild(span);
    container.appendChild(item);

    const penalty = { remaining: 120, interval: null, item, span };
    span.textContent = formatTime(penalty.remaining);

    const tick = () => {
        penalty.remaining--;
        if (penalty.remaining <= 0) {
            clearInterval(penalty.interval);
            penalty.interval = null;
            item.remove();
            activePenalties[team] = activePenalties[team].filter(p => p !== penalty);
        } else {
            span.textContent = formatTime(penalty.remaining);
        }
    };

    penalty.interval = setInterval(tick, 1000);
    activePenalties[team].push(penalty);
}

function pausePenaltyTimers() {
    Object.keys(activePenalties).forEach(t => {
        activePenalties[t].forEach(p => {
            if (p.interval) {
                clearInterval(p.interval);
                p.interval = null;
            }
        });
    });
}

function resumePenaltyTimers() {
    Object.keys(activePenalties).forEach(t => {
        activePenalties[t].forEach(p => {
            if (!p.interval) {
                p.interval = setInterval(() => {
                    p.remaining--;
                    if (p.remaining <= 0) {
                        clearInterval(p.interval);
                        p.interval = null;
                        p.item.remove();
                        activePenalties[t] = activePenalties[t].filter(x => x !== p);
                    } else {
                        p.span.textContent = formatTime(p.remaining);
                    }
                }, 1000);
            }
        });
    });
}




        // Funksjon for å åpne spiller-popup
        let currentEventType = 'goal';
        async function openPlayerModal(team, type = 'goal') {
            currentEventType = type;
            if (type === 'goal' && !logGoalScorersEnabled) {
                await logGoalAndUpdateScore('ikke-definert', team);
                return;
            }

            const titleEl = document.getElementById('modalTitle');
            const playerListElement = document.getElementById('playerList');
            playerListElement.innerHTML = '';

            let teamName = team === 'hjemme'
                ? document.getElementById('hjemmelagNavn').textContent
                : document.getElementById('bortelagNavn').textContent;

            switch (type) {
                case 'yellow':
                    titleEl.textContent = 'Velg spiller med gult kort';
                    break;
                case 'red':
                    titleEl.textContent = 'Velg spiller med rødt kort';
                    break;
                case 'penalty':
                    titleEl.textContent = 'Velg spiller for 2 minutters utvisning';
                    break;
                default:
                    titleEl.textContent = 'Velg spiller som scoret';
            }

            if (type === 'goal') {
                const predefinedOptions = [
                    { label: 'Ikke definert', value: 'ikke-definert' },
                    { label: 'Selvmål', value: 'selvmål' }
                ];

                predefinedOptions.forEach(option => {
                    const listItem = document.createElement('li');
                    listItem.textContent = option.label;
                    listItem.onclick = function() {
                        logGoalAndUpdateScore(option.value, team);
                        closeModal();
                    };
                    playerListElement.appendChild(listItem);
                });
            }

            // Hent spillere for laget fra Firebase
            db.collection('turneringer').doc(turneringId)
                .collection('lag').where('lagNavn', '==', teamName).get()
                .then(snapshot => {
                    if (!snapshot.empty) {
                        snapshot.forEach(doc => {
                            const spillerData = doc.data().spillere || [];
                            spillerData.forEach(spiller => {
                                const listItem = document.createElement('li');
                                listItem.textContent = spiller;
                                listItem.onclick = function() {
                                    if (currentEventType === 'goal') {
                                        logGoalAndUpdateScore(spiller, team);
                                        alert(spiller + ' scoret!');
                                    } else {
                                        logCard(spiller, team, currentEventType);
                                    }
                                    closeModal();
                                };
                                playerListElement.appendChild(listItem);
                            });
                        });
                    } else {
                        console.error('Ingen spillere funnet for laget:', teamName);
                        const listItem = document.createElement('li');
                        listItem.textContent = 'Ingen spillere funnet.';
                        playerListElement.appendChild(listItem);
                    }
                })
                .catch(error => {
                    console.error('Feil ved henting av spillere:', error);
                });

            // Vis modal
            document.getElementById('playerModal').style.display = 'block';
        }

        // Funksjon for å lukke modalen
        function closeModal() {
            document.getElementById('playerModal').style.display = 'none';
        }

        // Funksjon for å formatere tid i minutter og sekunder
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

     

         

        // Legg til event listeners for kontrollknappene
        document.getElementById("startBtn").addEventListener("click", () => {
  if (inPause) {
    inPause = false;
    startNextPeriod();
  } else {
    startTimer();
  }
});

// Hook opp knappene når DOM er klar
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('btnExtra').onclick = () => {
    // Vis ekstraomgang‑input, skjul resten
    document.getElementById('extraInputContainer').style.display = 'block';
    document.getElementById('penaltyInputContainer').style.display = 'none';
  };
  document.getElementById('btnPenalties').onclick = () => {
    document.getElementById('penaltyInputContainer').style.display = 'block';
    document.getElementById('extraInputContainer').style.display = 'none';
  };
  document.getElementById('confirmExtra').onclick = () => {
    const val = parseInt(document.getElementById('extraTimeInput').value, 10);
    if (isNaN(val) || val < 1) {
      alert('Vennligst oppgi et gyldig antall sekunder.');
      return;
    }
    applyExtraPeriod(val);
  };
  document.getElementById('confirmPenalties').onclick = () => {
    const cnt = parseInt(document.getElementById('penaltyCountInput').value, 10);
    if (isNaN(cnt) || cnt < 1) {
      alert('Vennligst oppgi et gyldig antall straffer.');
      return;
    }
    applyPenalties(cnt);
  };
});

// Erstatter gamle choose‑funksjoner:
function applyExtraPeriod(extraSeconds) {
  closeKnockoutModal();
  currentPeriod++;
  timeLeft = extraSeconds;
  document.getElementById('period').textContent = `${currentPeriod}. ekstra omgang`;
  // Oppdater Firestore om ønskelig:
  db.collection('turneringer').doc(turneringId)
    .collection('kamper').doc(kampId)
    .update({ tieBreakType: 'overtime', extraTime: extraSeconds });
  startTimer();
}

function applyPenalties(count) {
  closeKnockoutModal();
  // Sett opp state
  penaltyState.rounds = count;
  penaltyState.idx = 0;
  penaltyState.currentTeam = 'home';
  penaltyState.results = {
    home: Array(count).fill(null),
    away: Array(count).fill(null)
  };
  initPenaltyUI(count);
  document.getElementById('penaltyModal').style.display = 'block';
}

function initPenaltyUI(count) {
  const homeDots = document.getElementById('homeDots');
  const awayDots = document.getElementById('awayDots');
  homeDots.innerHTML = '';
  awayDots.innerHTML = '';

  for (let i = 0; i < count; i++) {
    homeDots.appendChild(document.createElement('div')).className = 'dot';
    awayDots.appendChild(document.createElement('div')).className = 'dot';
  }
  updateShooterUI();
}
function updateShooterUI() {
  const cs = document.getElementById('currentShooter');
  const teamId = penaltyState.currentTeam;
  const teamName = document.getElementById(
    teamId === 'home' ? 'homeName' : 'awayName'
  ).textContent;
  cs.textContent = `${teamName} skal skyte (${penaltyState.idx + 1}/${penaltyState.rounds})`;
}
/**
 * Håndterer ett straffeskudd: oppdaterer UI, lokal state og Firestore.
 * @param {boolean} scored – true for treff, false for bom
 */
 function handleShot(scored) {
  // 1) Les current team og runde-indeks
  const team  = penaltyState.currentTeam;  // 'home' eller 'away'
  const round = penaltyState.idx;          // 0-basert rundeindeks

  // 2) Lagre treff/bom i lokal state
  penaltyState.results[team][round] = scored;

  // 3) Oppdater UI‑dot for akkurat denne runden
  const container = document.getElementById(
    team === 'home' ? 'homeDots' : 'awayDots'
  );
  container.children[round].classList.add(scored ? 'score' : 'miss');

  // 4) Skriv hele penaltyDetails-objektet til Firestore
  db.collection('turneringer').doc(turneringId)
    .collection('kamper').doc(kampId)
    .update({
      penaltyDetails: {
        rounds:       penaltyState.rounds,
        idx:          penaltyState.idx,
        currentTeam:  penaltyState.currentTeam,
        results:      penaltyState.results
      }
    })
    .catch(error => console.error('Feil ved lagring av straffedetaljer:', error));

  // 5) Bytt tur: home → away, eller away → home + neste runde
  if (team === 'home') {
    penaltyState.currentTeam = 'away';
  } else {
    penaltyState.currentTeam = 'home';
    penaltyState.idx++;
  }

  // 6) Hvis ferdig, deaktiver knappene; ellers oppdater neste-skytetekst
  if (penaltyState.idx >= penaltyState.rounds) {
    document.getElementById('btnMiss').disabled = true;
    document.getElementById('btnScore').disabled = true;
    document.getElementById('currentShooter').textContent = 'Alle straffer tatt';
  } else {
    updateShooterUI();
  }
}

// Holder hele konkurransens data
let penaltyState = {
  rounds: 0,
  idx: 0,
  currentTeam: 'home',       // 'home' eller 'away'
  results: { home: [], away: [] }
};

function markPenalty(team, idx, scored) {
  // Oppdater state
  window.penaltyResults[team][idx] = scored;
  // Vis feedback på raden: f.eks. farge knapp eller tekst
  // Finn raden i DOM:
  const row = document.querySelectorAll('.penalty-row')[idx];
  // Marker: endre bakgrunn på knappen brukte sist:
  [...row.querySelectorAll('button')].forEach(btn => btn.classList.remove('selected'));
  const btns = row.querySelectorAll(`button:nth-child(${team==='home'?2:4})${scored?'':'+1'}`);
  // litt hack rundt nth-child, enklere kunne vært data-attribbuter...
  // For klarhet: du kan f.eks. legge data-team/data-round på knappene og så 
  // matche med btn.dataset.team==team && +btn.dataset.round==idx && btn.dataset.scored==scored
  // Men prinsippet er: gi valgt knapp en klassse 'selected'.
  btns[0].classList.add('selected');
}

document.getElementById('confirmPenaltyResults').onclick = () => {
  const { home, away, rounds } = window.penaltyResults;
  const homeScore = home.filter(x => x).length;
  const awayScore = away.filter(x => x).length;

  // Vis totalen et sted i UI
  alert(`Resultat:\n${homeScore} – ${awayScore}`);

  // Oppdater Firestore
  db.collection('turneringer').doc(turneringId)
    .collection('kamper').doc(kampId)
    .update({
      tieBreakType: 'penalties',
      homePenaltyScore: homeScore,
      awayPenaltyScore: awayScore,
      penaltyDetails: window.penaltyResults
    });

  closePenaltyModal();
  avsluttKamp();
};

function closePenaltyModal() {
  document.getElementById('penaltyModal').style.display = 'none';
}

document.getElementById('btnMiss').onclick = () => handleShot(false);
document.getElementById('btnScore').onclick = () => handleShot(true);

document.getElementById('confirmPenaltyResults').onclick = () => {
  const homeScore = penaltyState.results.home.filter(x => x).length;
  const awayScore = penaltyState.results.away.filter(x => x).length;

  alert(`Resultat: ${homeScore} – ${awayScore}`);

  // Oppdater til Firestore
  db.collection('turneringer').doc(turneringId)
    .collection('kamper').doc(kampId)
    .update({
      tieBreakType: 'penalties',
      homePenaltyScore: homeScore,
      awayPenaltyScore: awayScore,
      penaltyDetails: penaltyState
    });

  closePenaltyModal();
  avsluttKamp();
};

        document.getElementById("stopBtn").addEventListener("click", stopTimer);
        document.getElementById("resetBtn").addEventListener("click", resetTimer);
        document.getElementById("switchSidesBtn").addEventListener("click", switchSides);
    </script>
</body>
</html>

