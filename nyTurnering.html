<!DOCTYPE html>
<html lang="no">
<head>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" type="text/css" href="./admin.css">
  <title>Legg til Turnering</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <!-- Ekstra stil for turneringskortene -->
    <style>
      /* Container for knappene inni hvert turneringskort */
      .turnering-actions {
        display: flex;
        justify-content: space-between;
        gap: 10px;
        margin-top: 15px;
      }
  </style>
</head>
<body id="wrapper">
  <header>
    <div class="logo-title">
      <a href="index.html"><img src="logo.png" alt="Simple Scores Logo" class="logo"></a>
    </div>
    <div class="nav2">
      <button id="user-button" onclick="toggleUserMenu()">Bruker</button>
      <div id="user-menu" class="user-menu" style="display: none;">
        <p>Logget inn som <span id="mail"></span></p>
        <button id="loggut" onclick="loggut()">Logg ut</button>
      </div>
      <button onclick="window.location.href='publikum.html'">Publikum</button>
    </div>
  </header>
  
  <button onclick="endre()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded mt-4">Opprett turnering</button>
  <button onclick="manuell()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded mt-4">Manuell turnering</button>
  
  <main id="turneringListe" class="turnering-container"></main>
  <main id="coArrangorTurneringListe">
    <h2>Turneringer som Co-Arrangør</h2>
  </main>

  <!-- Q&A Seksjon -->
  <script src="https://www.gstatic.com/firebasejs/8.2.0/firebase-app.js"></script>
    <script src="firebaseConfig.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.2.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.2.0/firebase-auth.js"></script>
  <script>

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    auth.onAuthStateChanged((user) => {
      if (user) {
        const email = user.email;
        document.getElementById('mail').innerHTML = email;
        loadTurnering(email);
        loadCoArrangorTurneringer(email);
      } else {
        window.location.href = 'login.html';
      }
    });

    function loggut() {
      auth.signOut().then(() => {
        window.location.href = 'login.html';
      }).catch((error) => {
        console.error("Feil ved utlogging:", error);
      });
    }

    // Laster inn turneringene med styling som passer med resten av designet
    function loadTurnering(email) {
      const turneringListe = document.getElementById('turneringListe');
      turneringListe.innerHTML = '';
      db.collection('turneringer')
        .where('organizer', '==', email)
        .get()
        .then(snapshot => {
          snapshot.forEach(doc => {
            const turnering = doc.data();
            const turneringDiv = document.createElement('article');
            turneringDiv.className = 'turnering';

            // Bruk et h4-element for turneringsnavnet slik at stilen fra admin.css (turnering h4) gjelder
            const title = document.createElement('h4');
            title.textContent = turnering.tournamentName;
            turneringDiv.appendChild(title);

            // Opprett knapp-container for rediger og slett
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'turnering-actions';

            // Rediger-knapp
            const editButton = document.createElement('button');
            editButton.textContent = 'Rediger';
            editButton.className = 'flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 rounded';
            editButton.onclick = function(e) {
              e.stopPropagation();
              const newName = prompt("Skriv inn nytt navn for turneringen:", turnering.tournamentName);
              if (newName && newName.trim() !== "" && newName !== turnering.tournamentName) {
                db.collection('turneringer').doc(doc.id).update({
                  tournamentName: newName
                }).then(() => {
                  title.textContent = newName;
                  turnering.tournamentName = newName;
                }).catch(error => {
                  console.error("Feil ved oppdatering av turneringsnavn:", error);
                });
              }
            };
            actionsDiv.appendChild(editButton);

            // Slett-knapp
            const deleteButton = document.createElement('button');
            deleteButton.textContent = 'Slett';
            deleteButton.className = 'flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 rounded';
            deleteButton.onclick = function(e) {
              e.stopPropagation();
              if (confirm("Er du sikker på at du vil slette turneringen?")) {
                db.collection('turneringer').doc(doc.id).delete().then(() => {
                  turneringListe.removeChild(turneringDiv);
                }).catch(error => {
                  console.error("Feil ved sletting av turneringen:", error);
                });
              }
            };
            actionsDiv.appendChild(deleteButton);

            turneringDiv.appendChild(actionsDiv);

            // Klikk på kortet åpner riktig redigeringsside basert på om turneringen er manuell eller ikke
            turneringDiv.addEventListener('click', function() {
              if (turnering.manual) {
                window.location.href = 'manualMatches.html?id=' + doc.id;
              } else {
                window.location.href = 'leggtillag.html?id=' + doc.id;
              }
            });

            turneringListe.appendChild(turneringDiv);
          });
        }).catch(error => {
          console.error('Feil ved henting av turneringer:', error);
        });
    }

    function endre() {
      window.location.href = 'OpprettTurnering.html';
    }

    function manuell() {
      window.location.href = 'manualTurnering.html';
    }

    function loadCoArrangorTurneringer(email) {
  const coArrangorListe = document.getElementById('coArrangorTurneringListe');
  coArrangorListe.innerHTML = '<h2>Turneringer som Co-Arrangør</h2>';
  db.collectionGroup('coOrganizers')
    .where('email', '==', email)
    .get()
    .then(snapshot => {
      snapshot.forEach(async coDoc => {
        const turneringRef = coDoc.ref.parent.parent;
        const doc = await turneringRef.get();
        const turnering = doc.data();
        const turneringDiv = document.createElement('article');
        turneringDiv.className = 'turnering';
        turneringDiv.textContent = turnering.tournamentName;
        turneringDiv.addEventListener('click', () => {
          if (turnering.manual) {
            window.location.href = 'manualMatches.html?id=' + turneringRef.id;
          } else {
            window.location.href = 'leggtillag.html?id=' + turneringRef.id;
          }
        });
        coArrangorListe.appendChild(turneringDiv);
      });
    })
    .catch(error => {
      console.error('Feil ved henting av co-arrangør turneringer:', error);
    });
}

  </script>
</body>
</html>
